import React, { useState } from 'react';
import { Plus, Trash2, UserPlus } from 'lucide-react';
import { Card, CardHeader, CardTitle, CardContent } from '@/components/ui/card';

const ExpenseTracker = () => {
  const [participants, setParticipants] = useState([]);
  const [newParticipant, setNewParticipant] = useState('');
  const [expenses, setExpenses] = useState([]);
  const [newExpense, setNewExpense] = useState({
    description: '',
    amount: '',
    currency: '$',
    paidBy: '',
    splitBetween: []
  });

  // Airtable configuration
  const AIRTABLE_PERSONAL_TOKEN = 'patG3xfFhZGjGiXWt.8959878dca997d69972b237177713462c43fe7f385ab43d7d45ce500f104d703';
  const AIRTABLE_BASE_ID = 'app7aGU54LVkhT1fd';
  const AIRTABLE_TABLE_NAME = 'Expenses';

  const currencies = [
    { symbol: '£', label: 'GBP' },
    { symbol: '€', label: 'EUR' }
    { symbol: '$', label: 'HKD' },
  ];

  const addParticipant = (e) => {
    e.preventDefault();
    if (newParticipant && !participants.includes(newParticipant)) {
      setParticipants([...participants, newParticipant]);
      setNewParticipant('');
    }
  };

  const sendToAirtable = async (expenseData) => {
    try {
      const response = await fetch(`https://api.airtable.com/v0/${AIRTABLE_BASE_ID}/${AIRTABLE_TABLE_NAME}`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${AIRTABLE_PERSONAL_TOKEN}`,
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          fields: {
            Description: expenseData.description,
            Amount: parseFloat(expenseData.amount),
            Currency: expenseData.currency,
            PaidBy: expenseData.paidBy,
            SplitBetween: expenseData.splitBetween.join(', '),
            AmountPerPerson: expenseData.amountPerPerson,
            Date: expenseData.date
          }
        })
      });
      
      if (!response.ok) {
        throw new Error('Failed to save to Airtable');
      }
      
      return await response.json();
    } catch (error) {
      console.error('Error saving to Airtable:', error);
      throw error;
    }
  };

  const addExpense = async (e) => {
    e.preventDefault();
    if (!newExpense.description || !newExpense.amount || !newExpense.paidBy || newExpense.splitBetween.length === 0) {
      return;
    }

    const amountPerPerson = parseFloat(newExpense.amount) / newExpense.splitBetween.length;

    const expenseWithSplits = {
      ...newExpense,
      id: Date.now(),
      date: new Date().toLocaleDateString(),
      amountPerPerson: amountPerPerson.toFixed(2)
    };

    try {
      await sendToAirtable(expenseWithSplits);
      setExpenses([...expenses, expenseWithSplits]);
      setNewExpense({
        description: '',
        amount: '',
        currency: '$',
        paidBy: '',
        splitBetween: []
      });
    } catch (error) {
      alert('Failed to save expense. Please try again.');
    }
  };

  const deleteExpense = (id) => {
    setExpenses(expenses.filter(expense => expense.id !== id));
  };

  const calculateBalances = () => {
    const balances = {};
    
    expenses.forEach(expense => {
      balances[expense.paidBy] = (balances[expense.paidBy] || 0) + parseFloat(expense.amount);
      expense.splitBetween.forEach(person => {
        balances[person] = (balances[person] || 0) - parseFloat(expense.amountPerPerson);
      });
    });

    return balances;
  };

  return (
    <div className="max-w-2xl mx-auto p-4 space-y-6">
      <Card>
        <CardHeader>
          <CardTitle>Add Participants</CardTitle>
        </CardHeader>
        <CardContent>
          <form onSubmit={addParticipant} className="flex gap-2">
            <input
              type="text"
              placeholder="Enter participant name"
              value={newParticipant}
              onChange={(e) => setNewParticipant(e.target.value)}
              className="flex-1 p-2 border rounded"
            />
            <button
              type="submit"
              className="flex items-center gap-2 bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600"
            >
              <UserPlus size={16} /> Add
            </button>
          </form>
          <div className="mt-4 flex flex-wrap gap-2">
            {participants.map(participant => (
              <span key={participant} className="bg-gray-100 px-3 py-1 rounded">
                {participant}
              </span>
            ))}
          </div>
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <CardTitle>Add New Expense</CardTitle>
        </CardHeader>
        <CardContent>
          <form onSubmit={addExpense} className="space-y-4">
            <div className="grid grid-cols-2 gap-4">
              <input
                type="text"
                placeholder="Description"
                value={newExpense.description}
                onChange={(e) => setNewExpense({...newExpense, description: e.target.value})}
                className="p-2 border rounded"
              />
              <div className="flex gap-2">
                <input
                  type="number"
                  placeholder="Amount"
                  value={newExpense.amount}
                  onChange={(e) => setNewExpense({...newExpense, amount: e.target.value})}
                  className="flex-1 p-2 border rounded"
                />
                <select
                  value={newExpense.currency}
                  onChange={(e) => setNewExpense({...newExpense, currency: e.target.value})}
                  className="p-2 border rounded"
                >
                  {currencies.map(curr => (
                    <option key={curr.symbol} value={curr.symbol}>
                      {curr.symbol} ({curr.label})
                    </option>
                  ))}
                </select>
              </div>
              <select
                value={newExpense.paidBy}
                onChange={(e) => setNewExpense({...newExpense, paidBy: e.target.value})}
                className="p-2 border rounded"
              >
                <option value="">Select who paid</option>
                {participants.map(participant => (
                  <option key={participant} value={participant}>
                    {participant}
                  </option>
                ))}
              </select>
              <select
                multiple
                value={newExpense.splitBetween}
                onChange={(e) => setNewExpense({
                  ...newExpense,
                  splitBetween: Array.from(e.target.selectedOptions, option => option.value)
                })}
                className="p-2 border rounded"
              >
                {participants.map(participant => (
                  <option key={participant} value={participant}>
                    {participant}
                  </option>
                ))}
              </select>
            </div>
            <button
              type="submit"
              className="w-full flex items-center justify-center gap-2 bg-blue-500 text-white p-2 rounded hover:bg-blue-600"
            >
              <Plus size={16} /> Add Expense
            </button>
          </form>
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <CardTitle>Expenses List</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-4">
            {expenses.map(expense => (
              <div key={expense.id} className="flex items-center justify-between p-4 border rounded">
                <div>
                  <div className="font-semibold">{expense.description}</div>
                  <div className="text-sm text-gray-600">
                    Paid by: {expense.paidBy} • Amount: {expense.currency}{expense.amount}
                  </div>
                  <div className="text-sm text-gray-600">
                    Split between: {expense.splitBetween.join(', ')}
                  </div>
                  <div className="text-sm text-gray-600">
                    Amount per person: {expense.currency}{expense.amountPerPerson}
                  </div>
                </div>
                <button
                  onClick={() => deleteExpense(expense.id)}
                  className="text-red-500 hover:text-red-700"
                >
                  <Trash2 size={16} />
                </button>
              </div>
            ))}
          </div>
        </CardContent>
      </Card>

      <Card>
        <CardHeader>
          <CardTitle>Final Balances</CardTitle>
        </CardHeader>
        <CardContent>
          <div className="space-y-2">
            {Object.entries(calculateBalances()).map(([person, amount]) => (
              <div key={person} className="flex justify-between p-2 border-b">
                <span>{person}</span>
                <span className={amount > 0 ? 'text-green-500' : 'text-red-500'}>
                  ${amount.toFixed(2)}
                </span>
              </div>
            ))}
          </div>
        </CardContent>
      </Card>
    </div>
  );
};

export default ExpenseTracker;
