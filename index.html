<!DOCTYPE html>
<html lang="en">
<!-- Previous head and style sections remain the same -->
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Expense Splitter</title>
    <!-- Previous styles remain the same -->
</head>
<body>
    <!-- Previous HTML structure remains the same -->
    <script>
        const AIRTABLE_TOKEN = 'patG3xfFhZGjGiXWt.8959878dca997d69972b237177713462c43fe7f385ab43d7d45ce500f104d703';
        const BASE_ID = 'app7aGU54LVkhT1fd';
        const participants = [];
        const expenses = [];

        // Add logging function
        function log(message, error = false) {
            const style = error ? 'color: red' : 'color: green';
            console.log(`%c${message}`, style);
        }

        async function saveToAirtable(table, data) {
            try {
                const response = await fetch(`https://api.airtable.com/v0/${BASE_ID}/${table}`, {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_TOKEN}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        records: [{
                            fields: data
                        }]
                    })
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Airtable Error: ${JSON.stringify(errorData)}`);
                }

                const result = await response.json();
                log(`Successfully saved to ${table}`);
                return result;
            } catch (error) {
                log(`Error saving to ${table}: ${error.message}`, true);
                throw error;
            }
        }

        async function addParticipant() {
            const name = document.getElementById('participant-name').value.trim();
            if (!name) return;

            try {
                // Save to Airtable first
                await saveToAirtable('Participants', {
                    Name: name
                });

                // If successful, update local state
                participants.push(name);
                updateParticipantsList();
                updatePaidBySelect();
                document.getElementById('participant-name').value = '';
                log(`Added participant: ${name}`);
            } catch (error) {
                alert('Error saving participant. Please try again.');
            }
        }

        async function addExpense() {
            const description = document.getElementById('expense-description').value;
            const amount = parseFloat(document.getElementById('expense-amount').value);
            const currency = document.getElementById('currency').value;
            const paidBy = document.getElementById('paid-by').value;
            const splitType = document.getElementById('split-type').value;

            if (!description || !amount || !paidBy) {
                alert('Please fill in all required fields');
                return;
            }

            let shares = {};
            if (splitType === 'equal') {
                const share = amount / participants.length;
                participants.forEach(p => shares[p] = share);
            } else {
                const splitInputs = document.getElementsByClassName('split-amount');
                participants.forEach((p, i) => shares[p] = parseFloat(splitInputs[i].value) || 0);
            }

            const expense = {
                description,
                amount,
                currency,
                paidBy,
                shares: JSON.stringify(shares),
                date: new Date().toISOString()
            };

            try {
                // Save to Airtable first
                await saveToAirtable('Expenses', expense);

                // If successful, update local state
                expenses.push({
                    ...expense,
                    shares: JSON.parse(expense.shares)
                });

                updateTransactionsTable();
                updateSettlementSummary();

                // Clear form
                document.getElementById('expense-description').value = '';
                document.getElementById('expense-amount').value = '';
                document.getElementById('split-amounts').innerHTML = '';
                log(`Added expense: ${description}`);
            } catch (error) {
                alert('Error saving expense. Please try again.');
            }
        }

        // Modified load functions with better error handling
        async function loadFromAirtable(table) {
            try {
                const response = await fetch(`https://api.airtable.com/v0/${BASE_ID}/${table}`, {
                    headers: {
                        'Authorization': `Bearer ${AIRTABLE_TOKEN}`
                    }
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(`Airtable Error: ${JSON.stringify(errorData)}`);
                }

                const data = await response.json();
                log(`Successfully loaded ${table}`);
                return data.records;
            } catch (error) {
                log(`Error loading ${table}: ${error.message}`, true);
                throw error;
            }
        }

        async function loadParticipants() {
            try {
                const records = await loadFromAirtable('Participants');
                participants.length = 0; // Clear existing
                records.forEach(record => {
                    participants.push(record.fields.Name);
                });
                updateParticipantsList();
                updatePaidBySelect();
            } catch (error) {
                alert('Error loading participants. Please refresh the page.');
            }
        }

        async function loadExpenses() {
            try {
                const records = await loadFromAirtable('Expenses');
                expenses.length = 0; // Clear existing
                records.forEach(record => {
                    expenses.push({
                        description: record.fields.Description,
                        amount: record.fields.Amount,
                        currency: record.fields.Currency,
                        paidBy: record.fields.PaidBy,
                        shares: JSON.parse(record.fields.Shares),
                        date: record.fields.Date
                    });
                });
                updateTransactionsTable();
                updateSettlementSummary();
            } catch (error) {
                alert('Error loading expenses. Please refresh the page.');
            }
        }

        // Rest of the functions (updateTransactionsTable, updateSettlementSummary, etc.) remain the same

        // Load data on page load
        loadParticipants();
        loadExpenses();
    </script>
</body>
</html>
